<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ì†Œì¼“ ì±„íŒ… í´ë¼ì´ì–¸íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .chat-container { max-width: 600px; margin: 40px auto; background: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .message-box { padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; max-width: 75%; }
        .my-message { background-color: #DCF8C6; margin-left: auto; text-align: right; }
        .other-message { background-color: #E5E7EB; margin-right: auto; text-align: left; }
    </style>
</head>
<body class="p-4">

<div class="chat-container rounded-xl p-6">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">ì‹¤ì‹œê°„ ì›¹ì†Œì¼“ ì±„íŒ…</h1>

    <div id="chat-window" class="h-96 overflow-y-auto border border-gray-200 p-4 mb-4 rounded-lg bg-gray-50 flex flex-col">
        <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        <p class="text-gray-500 text-center mb-4">ì±„íŒ… ì„œë²„ì— ì—°ê²° ì¤‘...</p>
    </div>

    <div class="flex space-x-3">
        <!-- ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„ì„ ì„ì˜ë¡œ ì„¤ì • (ì‹¤ì œ ì•±ì—ì„œëŠ” ë¡œê·¸ì¸ ì •ë³´ ì‚¬ìš©) -->
        <input type="text" id="sender-input" value="ìµëª…ì‚¬ìš©ì" class="p-2 border border-gray-300 rounded-lg w-1/4 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="ë‹‰ë„¤ì„">
        <input type="text" id="message-input" class="p-2 border border-gray-300 rounded-lg flex-grow focus:ring-blue-500 focus:border-blue-500" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeyup="if(event.key === 'Enter') sendMessage()">
        <button id="send-button" onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">ì „ì†¡</button>
    </div>

    <div id="status" class="mt-4 text-sm text-center font-medium">
        <span class="text-red-500">ì—°ê²° ëŠê¹€</span>
    </div>
</div>

<script>
    // í˜„ì¬ ì ‘ì†í•œ ì‚¬ìš©ìì˜ ì„ì˜ IDë¥¼ ìƒì„± (ì„¸ì…˜ êµ¬ë¶„ì„ ìœ„í•¨)
    const MY_SENDER_ID = 'user-' + Math.random().toString(36).substring(2, 9);

    // ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: ngrokì„ í†µí•´ ë°°í¬ëœ ì„œë²„ ì£¼ì†Œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    // í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ì´ ì‹¤í–‰ë˜ëŠ” ë„ë©”ì¸ê³¼ ì„œë²„ ë„ë©”ì¸ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ì£¼ì†Œë¥¼ ê³ ì •í•´ì•¼ í•©ë‹ˆë‹¤.
    const SERVER_HOST = "kourtney-rewirable-fumiko.ngrok-free.dev";
    const protocol = 'wss'; // ngrokì€ HTTPSë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì›¹ì†Œì¼“ì€ WSSë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
    const endpoint = "/ws/chat"; // Spring Boot ì›¹ì†Œì¼“ ì—”ë“œí¬ì¸íŠ¸ ê²½ë¡œ

    const websocket = new WebSocket(`${protocol}://${SERVER_HOST}${endpoint}`);

    const chatWindow = document.getElementById('chat-window');
    const messageInput = document.getElementById('message-input');
    const senderInput = document.getElementById('sender-input');
    const statusDiv = document.getElementById('status');

    // 1. ì—°ê²° ì„±ê³µ ì‹œ
    websocket.onopen = function() {
        console.log("ì›¹ì†Œì¼“ ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ì†Œ:", `${protocol}://${SERVER_HOST}${endpoint}`);
        statusDiv.innerHTML = `<span class="text-green-600">ì—°ê²° ì„±ê³µ</span>`;
        // ì²˜ìŒ ì—°ê²° ì‹œ ì…ì¥ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤ (ENTER íƒ€ì…)
        sendControlMessage(senderInput.value, 'ENTER');
    };

    // 2. ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ
    websocket.onmessage = function(event) {
        const payload = event.data;
        console.log("ë©”ì‹œì§€ ìˆ˜ì‹ :", payload);

        try {
            // ì„œë²„ì—ì„œ ë³´ë‚¸ JSON ë¬¸ìì—´ì„ ê°ì²´ë¡œ ë³€í™˜
            const message = JSON.parse(payload);

            // ì˜¤ë¥˜ ë©”ì‹œì§€ ì²˜ë¦¬
            if (message.error) {
                displayMessage('System', `ì˜¤ë¥˜: ${message.error}`, 'system');
                return;
            }

            // ChatMessage DTO í˜•íƒœì˜ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
            displayMessage(message.sender, message.content, message.type, message.timestamp);

        } catch (e) {
            console.error("ìˆ˜ì‹  ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:", e);
            displayMessage('System', 'ìˆ˜ì‹ ëœ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'system');
        }
    };

    // 3. ì—°ê²° ë‹«í˜ ì‹œ
    websocket.onclose = function() {
        console.log("ì›¹ì†Œì¼“ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        statusDiv.innerHTML = `<span class="text-red-500">ì—°ê²° ëŠê¹€</span>`;
    };

    // 4. ì˜¤ë¥˜ ë°œìƒ ì‹œ
    websocket.onerror = function(error) {
        console.error("ì›¹ì†Œì¼“ ì˜¤ë¥˜ ë°œìƒ:", error);
        statusDiv.innerHTML = `<span class="text-red-500">ì˜¤ë¥˜ ë°œìƒ</span>`;
    };

    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (TALK íƒ€ì…)
    function sendMessage() {
        if (websocket.readyState === WebSocket.OPEN) {
            const sender = senderInput.value || 'ìµëª…';
            const content = messageInput.value.trim();

            if (content === "") return;

            // ì„œë²„ì˜ ChatMessage DTOì— ë§ê²Œ ê°ì²´ ìƒì„±
            const chatMessage = {
                sender: sender,
                content: content,
                type: "TALK" // ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€ íƒ€ì…
                // IDì™€ timestampëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
            };

            // ê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜(ì§ë ¬í™”)í•˜ì—¬ ì „ì†¡í•©ë‹ˆë‹¤.
            websocket.send(JSON.stringify(chatMessage));

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            messageInput.value = '';
            messageInput.focus();
        } else {
            alertMessage('ì›¹ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
        }
    }

    // ì œì–´ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (ENTER, LEAVE ë“±)
    function sendControlMessage(senderName, type) {
        if (websocket.readyState === WebSocket.OPEN) {
            const message = {
                sender: senderName,
                content: type === 'ENTER' ? `${senderName} ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.` : `${senderName} ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.`,
                type: type
            };
            websocket.send(JSON.stringify(message));
        }
    }

    // ì‹œê°„ í˜•ì‹ì„ 'ì˜¤í›„ 7:58' í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function formatTime(timestamp) {
        if (!timestamp) return '';

        let date;
        try {
            // Spring Bootì—ì„œ LocalDateTimeì´ 'YYYY-MM-DDTHH:MM:SS.SSS' í˜•íƒœì˜ ë¬¸ìì—´ë¡œ ì „ì†¡ë¨
            if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                date = new Date(timestamp);
            }
        } catch (e) {
            return '';
        }

        if (isNaN(date.getTime())) {
            return '';
        }

        const hours = date.getHours();
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
        const displayHours = hours % 12 || 12; // 0ì‹œë¥¼ 12ì‹œë¡œ í‘œì‹œ

        return `${ampm} ${displayHours}:${minutes}`;
    }

    // ë©”ì‹œì§€ í™”ë©´ ì¶œë ¥ í•¨ìˆ˜
    function displayMessage(sender, content, type, timestamp) {
        const messageElement = document.createElement('div');
        const senderId = senderInput.value; // í˜„ì¬ ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„

        // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë° ë‚´ìš© ê²°ì •
        if (type === 'ENTER' || type === 'LEAVE') {
            messageElement.className = 'text-center text-gray-500 italic text-sm mt-2';
            messageElement.textContent = content;
        } else {
            // ì¼ë°˜ ëŒ€í™” ë©”ì‹œì§€
            const isMyMessage = sender === senderId; // ë‹‰ë„¤ì„ìœ¼ë¡œ íŒë‹¨

            messageElement.className = `message-box ${isMyMessage ? 'my-message' : 'other-message'}`;
            messageElement.innerHTML = `
                <div class="font-bold text-xs ${isMyMessage ? 'text-green-800' : 'text-blue-800'}">${sender}</div>
                <div class="mt-1 break-words">${content}</div>
                <div class="text-xs text-gray-500 mt-1">${formatTime(timestamp)}</div>
            `;
        }

        chatWindow.appendChild(messageElement);
        // í•­ìƒ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // ê°„ë‹¨í•œ ì»¤ìŠ¤í…€ ì•Œë¦¼ ë©”ì‹œì§€ í•¨ìˆ˜
    function alertMessage(message) {
        // ê¸°ì¡´ alert() ëŒ€ì‹  ì‚¬ìš©í•  ê°„ë‹¨í•œ í‘œì‹œ
        const tempAlert = document.createElement('div');
        tempAlert.className = 'fixed top-4 right-4 bg-yellow-400 text-gray-800 p-3 rounded-lg shadow-lg z-50 transition-opacity duration-300';
        tempAlert.textContent = message;
        document.body.appendChild(tempAlert);
        setTimeout(() => tempAlert.remove(), 3000);
    }

    // ì°½ì„ ë‹«ì„ ë•Œ ë‚˜ê°€ëŠ” ë©”ì‹œì§€ ì „ì†¡
    window.addEventListener('beforeunload', () => {
        sendControlMessage(senderInput.value, 'LEAVE');
        websocket.close();
    });
</script>

</body>
</html>
